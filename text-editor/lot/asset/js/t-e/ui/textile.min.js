/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.4.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.ui.Textile=function(e,t){function _(e){return g(e.replace(/\s+/g," "))}function w(e){return m(_(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function x(e){return m(_(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function z(e){var c,t=r.$(),n=t.value,l=t.before,i=t.after,a=u(e),s=$("(^|\\n)"+a+"(.*)$"),f=$("^"+a,"gm"),o=E[""];return r[0](),n?$(a+"$").test(l)?r.unwrap(e,""):(r.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),f.test(n)?r.replace(f,""):r.replace(/(^|\n{2})/g,"$1"+e)):i&&l&&("\n"!==i[0]||"\n"!==l.slice(-1))?(c=s.test(l)?l.replace(s,"$1$2"):l.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),r.set(c+i).select(c.length)):r.tidy("\n\n").insert(e,0).insert(o),r[1](),!1}var n=TE.ui.HTML||TE.ui,r=n(e,{auto_close:{"@":"@","*":"*",_:"_","-":"-"},tools:"b i s | a img | note abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{tools:{note:["Footnote","⌘+↓"]},modals:{a:{title:["Link URL/Reference ID"]},note:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),l=r.ui,i=TE.is,a=i.o,s=function(e){return!i.x(e)},o=(i.s,r._),c=o.edge,u=o.x,p=o.extend,d=o.format,h=o.i,$=o.pattern,m=o.replace,g=o.trim,b="*",v="#",k=u(b),y=u(v);r.update(t,0),r.type="Textile";var q=r.config,T=q.formats,O=q.languages,S=q.states,E=(q.tab,O.placeholders);return r.mark=function(e,t,n,l){a(e)||(e=[e]),s(n)||(n=" "),s(l)||(l="");var i=r.h,f=r[0]().$(),o=e[0]+l,c=l+(s(e[1])?e[1]:e[0]),p=f.value,d=u(o),h=u(c),m=$("^"+d+"([\\s\\S]*?)"+h+"$"),g=$(d+"$"),b=$("^"+h),v=f.before,k=f.after;return p?n=!1:r.insert(E[""]),r.toggle(t?!m.test(p):!g.test(v)&&!b.test(k),[function(e){e.unwrap(o,c,1).tidy(/<[^\/<>]+?>$/.test(v)?"":n,/^<\/[^<>]+?>/.test(k)?"":n).wrap(o,c,t)},function(e){e.unwrap(o,c,t)}])[i]()},p(l.tools,{b:{click:function(e,t){return t.i().mark(T.b[0]),!1}},i:{click:function(e,t){return t.i().mark(T.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var p,d,h,$,m,b,v,n=t.$(),r=n.before,i=n.value,a=n.after,s=t.get(),f=/^\[\S+?\]/.test(s.split("\n").pop())?"\n":"\n\n",o=s.match(/^\[\S+?\]/gm)||[],c=O.modals.a,u=c.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(v in o)v=" "+g(o[v]).replace(/^\[|\]$/g,""),S.a[v]=1;return p=S.a,l.prompt(c.title[0],u,1,function(e,t,s){s=x(s),t[0](),p[s]?(t.trim(g(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(a)?!1:" ").mark(['"','":'+s],0,!1),$=o.indexOf("["+s+"]"),-1===$&&1!==p[s]&&(n=t.$(),r=n.before,m=n.start,b=n.end,t.set(r+n.value+g(n.after,1)+f+"["+(s||g(i)||E[""])+"]"+p[s][0]).select(m,b))):(d=s,l.prompt(c.title[1],c.placeholder[1],0,function(e,t,n){h=w(n),/^\![^\s]+?\!$/.test(i)?(h&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+h+")!"),t.insert(":"+d,1)):(i||t.insert(E[""]),t.i().trim(g(r)?" ":"",g(a)?/^\n+(fn\d+\^?\. |\[)/.test(a)?"\n\n":" ":"").wrap('"',(h?"("+h+")":"")+'":'+d))},0,0,"a[title]")),t[1]()},0,0,"a[href]").record(),!1}},img:{click:function(e,t){var i,a,r=(t.$(),O.modals.img);return l.prompt(r.title[0],r.placeholder[0],1,function(e,t,n){i=x(n),l.prompt(r.title[1],r.placeholder[1],0,function(e,t,n){a=w(n),t.tidy("\n\n","").insert("!"+i+(a?"("+a+")":"")+"!\n\n",0)},0,0,"img[title]")},0,0,"img[src]"),!1}},abbr:{click:function(e,t){var p,n=t.$(),r=g(n.value),i=O.modals.abbr,a=t.get(),s=_(r||E[""]),f=a.match(/\b[A-Z\d]+\(.*?\)/g)||[],o=S.abbr,c=/\(.*?\)/,u=0;for(u in f)p=f[u].match(/^(.*?)\((.*?)\)$/),S.abbr[p[1]]=g(p[2]);return o=S.abbr,r&&o[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+o[r]+")",1),!1):(l.prompt(i.title,o[s]||i.placeholder,!o[r],function(e,t,n,l){n=w(n||l),t[0](),r||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in o)if(w(o[u])===n){t.insert(u);break}t.unwrap("",c).unwrap("",c,1).i().tidy(" ").insert("("+n+")",1)[1]()},0,0,"abbr[title]").record(),!1)}},p:{click:function(e,t){return z("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var l,i,n=t.$(),r=/(?:p|h\d+)\. +/;return(l=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(l=n.value.match(/^(?:p|h([1-6]))\. /)||[]),i=+(l[1]||0),t[0]().i(),n.value||t.insert(E[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>i?"h"+(i+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return z("bq. ")}},"pre,code":{click:function(e,t){return $("(^|\\n)$").test(t.$().before)?z("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var u,n=t.$(),r=n.value,l=n.before,i=n.after,a=$("(^|\\n)([\\t ]*)"+k+" (.*)$"),s=$("^(.*)"+k+" ","gm"),f=$("(^|\\n)([\\t ]*)"+y+" (.*)$"),o=$("^(.*)"+y+" ","gm"),c=E[""];return r?(r===c?t.select():o.test(r)?t.replace(o,"$1"+b+" "):s.test(r)?t.replace(s,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+b+" $2"),!1):l&&i?(u=f.test(l)?l.replace(f,"$1$2"+b+" $3"):a.test(l)?l.replace(a,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+b+" $3"),t.set(u+i).select(u.length),!1):(t[0]().tidy("\n\n").insert(b+" ",0).insert(c)[1](),!1)}},ol:{click:function(e,t){var u,n=t.$(),r=n.value,l=n.before,i=n.after,a=$("(^|\\n)([\\t ]*)"+k+" (.*)$"),s=$("^(.*)"+k+" ","gm"),f=$("(^|\\n)([\\t ]*)"+y+" (.*)$"),o=$("^(.*)"+y+" ","gm"),c=E[""];return r?(r===c?t.select():s.test(r)?t.replace(s,function(e,t,n){return t+v+" "}):o.test(r)?t.replace(o,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+v+" "+n}),!1):l&&i?(u=a.test(l)?l.replace(a,"$1$2"+v+" $3"):f.test(l)?l.replace(f,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+v+" $3"),t.set(u+i).select(u.length),!1):(t[0]().tidy("\n\n").insert(v+" ",0).insert(c)[1](),!1)}},table:function(e,t){var u,p,$,n=S.tr,r=S.td,i=O.modals.table,a=O.placeholders.table,s=d(a[0],[1,1]),f=q.advance_table,o=[];return t[0]().$().value===s?(t.select(),!1):(l.prompt(i.title[0],i.placeholder[0],0,function(e,t,m,g){p=c(h(m)||g,r[0],r[1]),l.prompt(i.title[1],i.placeholder[1],0,function(e,t,r,l){$=c(h(r)||l,n[0],n[1]);var i,m,b,v,k;for(i=0;$>i;++i){for(u="|",m=0;p>m;++m)u+="   "+d(a[1],[i+1,m+1])+" |";o.push(u)}for(o=o.join("\n"),u="|",b=0;p>b;++b)u+="_. "+d(a[0],[1,b+1])+" |";if(f){for(u+="\n|~.\n|",b=0;p>b;++b)u+="   "+d(a[2],[1,b+1])+" |";u+="\n|-."}o=u+"\n"+o,f&&(o="|^.\n"+o),t.tidy("\n\n").insert(o),v=t.$(),k=v.start+v.value.indexOf(s),t.select(k,k+s.length)[1]()},0,0,"table>tr")},0,0,"table>td"),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(T.hr[0]+"\n\n",0).scroll(2),!1}},note:{click:function(t,n){var p,r=n.$(),a=(r.before,r.after),s=O.modals.note,f=n.get(),o=/^fn\d+\^?\. /.test(g(f).split("\n").pop())?"\n":"\n\n",c=f.match(/^fn\d+\^?\. /gm)||[],u=0;return u=c.length+1,l.prompt(s.title,u,0,function(t,n,r,l){r=g(r)||g(l)||u,p=c.indexOf("fn"+h(r)+". "),-1!==p?(u=f.indexOf(c[p])+2,n.select(u,u+r.length),e.scrollTop=n.$(1).caret[0].y):n.trim("",!g(a)||/^[\t ]*\n+[\t ]*/.test(a)?"\n\n":" ").insert("["+r+"]").set(g(n.get(),1)+o+"fn"+r+". ").focus(1).insert(E[""])},0,0,"note[id]"),!1}}}),p(l.keys,{"control+u":0,"shift+enter":0,enter:function(e,t){var n=t.$(),r="((?:"+k+"|"+y+")+ )",l=$("^"+r+".*$","gm").exec(n.before.split("\n").pop());return l?l[0]===l[1]?(t.outdent($(r)),!1):(t.insert("\n"+l[1],0).scroll(1),!1):void 0},"shift+tab":function(e,t){var n=t.$(),r=n.value,i=n.before,a="(^|\\n)("+k+"){2,}",s="(^|\\n)("+y+"){2,}";return r===E[""]?(t.select(),!1):$(a+" $").test(i)?(t.replace($(k+" $")," ",0),!1):$(a).test(r)?(t.replace($("^"+k+" *","gm"),""),!1):$(s+" $").test(i)?(t.replace($(y+" $")," ",0),!1):$(s).test(r)?(t.replace($("^"+y+" *","gm"),""),!1):l.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),r=n.value,i=n.before,a="(^|\\n)("+k+")+",s="(^|\\n)("+y+")+";return r===E[""]?(t.select(),!1):$(a+" $").test(i)?(t.replace(/ $/,b+" ",0),!1):$(a).test(r)?(t.replace(/^(?!$)/gm,b),!1):$(s+" $").test(i)?(t.replace(/ $/,v+" ",0),!1):$(s).test(r)?(t.replace(/^(?!$)/gm,v),!1):l.tools.indent.click(e,t)},"control+down":"note","control+up":"note"}),r.update({},0)};